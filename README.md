[*Click here to tranlate in English*](https://github.com/MongooseOrion/UltraSonic-Design_based-on-FPGA/blob/main/v1.1/README_EN.md)
# 基于FPGA的超声波测距系统
这是一个非常简单的设计例子，该类别中存在一些非常优秀的工程，该项目仅作为一种展示。<br><br>
**开发平台**：*Windows11 21H2*, *Vivado 2018.2*
## 单片机与FPGA分别构建超声波测距系统对比
FPGA 是近年来发展迅速且发展前景仍然非常明朗的一种可编程逻辑器件。在结构上，它由逻辑功能块排列为阵列，并通过可编程的内部连线来连接这些功能块。其功能由逻辑结构的配置数据决定，通过修改一根或多根内连线的布线可实现编程。典型的超声波测距系统设计，既可以使用单片机平台，也可使用 FPGA 平台，这里对两者进行一些梳理：
* 单片机：可采用 C 语言进行编程，这意味着可以非常方便地实现各种复杂的指令控制，令用户实现功能有更高的自由度。但是，在时序控制能力和时钟频率产生方面表现不佳，外部晶振大多仅提供 40MHz 的时钟输入，运行速度仅几十兆赫兹，并且难以实现复杂的组合逻辑电路设计。同时采用高级编程语言作为控制指令，意味着运行方式为顺序执行每条指令，这会极大地增加时延，尤其是在数据量庞大时，效率不佳。另外，外部 I/O 引脚数量不多，可扩展性极大地受到限制，并且接口协议的控制能力一般。
* FPGA：只存在可被配置的逻辑单元而不存在被固化的控制单元，因此控制能力强弱只取决于用户的需求。由于采用硬件描述语言（HDL）来部署电路行为，因此逻辑实现是并行执行的，时延不大，效率相对更高。同时具有很强的时序控制与时钟产生能力，外部晶振能提供百兆赫兹时钟，可使芯片内运行速率达百兆赫兹，最高可至 300MHz。另外，外部 I/O 扩展接口可以很多，可以同时将多个不同速率和协议的高速接口直接耦合和桥接。

超声波测距系统中对回波的处理和距离数据计算工作是至关重要的设计部分，它决定着系统能否实现，以及性能表现如何，超声波渡越时间测量精确性是一个重要参数。使用单片机作为系统控制平台进行数据处理，超声波渡越时间的计算可能不够准确，这是因为利用 12MHz 的晶振来进行计算，顺序执行的时延不可忽略，不管采用何种方式实现定时与计数工作，在数据量较大，也即距离较远时，这种影响会变得很大，与理论值的差距就会比较大。同时，定时器的计时也会存在一些误差，这是由于中断信号传入时序不同步造成的影响，该影响无法完全消除。如果采用高速脉冲来激励定时器计时的方式，则单片机的运行速度又会限制高频率的计数脉冲稳定地形成，因此单片机能够提升精度的空间很小。
## 设计组成
该系统使用 *Xilinx ZYNQ* 平台进行设计，采用超声波传感器 *HC-SR04* 作为外部监测设备。可将功能分为如下几个模块：
* 顶层模块
* 时钟
* 测距模块
  * 信号触发程序块
  * 回波处理程序块
  * 波形发生程序块
  * 高速计数程序块
* 显示模块<br><br>
<img src="https://github.com/MongooseOrion/UltraSonic-Design_based-on-FPGA/blob/main/v1.1/Picture/%E7%BB%98%E5%9B%BE4.png" width = '200' alt="图片alt" title="程序设计基本框架" /><br>
## 时钟
本系统使用 ***50MHz*** 时钟作为系统主时钟，使用 ***17kHz*** 信号作为计数脉冲进行测距。其中，*50MHz* 时钟需使用 *Vivado* IP库中的时钟模块才能将板载晶振的频率配置为需要的频率。<br>
## 测量模块
### 信号触发子模块
触发信号 *Trig* 需有 10μs 的上沿脉冲宽度才能使 HC-SR04 传感器工作。全局系统时钟为 ***50MHz***，周期为 0.02μs，则 **10μs** 的时间就对应为 *500* 个时钟单位。<br><br>
<img src="https://github.com/MongooseOrion/UltraSonic-Design_based-on-FPGA/blob/main/v1.1/Picture/%E7%BB%98%E5%9B%BE7.png" width = '300' alt="图片alt" title="信号触发子模块程序设计框图" /> 
<img src="https://github.com/MongooseOrion/UltraSonic-Design_based-on-FPGA/blob/main/v1.1/Picture/%E7%BB%98%E5%9B%BE6.png" width = '395' alt="图片alt" title="回波处理子模块程序设计框图" /><br>
### 回波处理子模块
该子程序将用于生成 ***17kHz*** 计数脉冲的使能信号。由于回响信号 *Echo* 的高电平持续时间就是超声波从发射到返回的持续时间，故测量距离则只需确定单个高电平波形的上升沿和下降沿之间的时间宽度即可。
### 波形发生子模块
主时钟 ***50MHz*** 不能被计数脉冲 *17kHz* 整除，所以取整对应约为 **2942** 个时钟单位（50% 占空比），通过定义寄存器计数 **2942** 次清零就可以实现 *17kHz* 分频。<br><br>
<img src="https://github.com/MongooseOrion/UltraSonic-Design_based-on-FPGA/blob/main/v1.1/Picture/%E7%BB%98%E5%9B%BE5.png" width = '300' alt="图片alt" title="波形发生子模块程序设计框图" /> 
<img src="https://github.com/MongooseOrion/UltraSonic-Design_based-on-FPGA/blob/main/v1.1/Picture/%E7%BB%98%E5%9B%BE8.png" width = '327' alt="图片alt" title="高速计数子模块程序设计框图" /><br>
### 高速计数子模块
该子程序用于计算 *Echo* 信号高电平的持续时间。设 Q 为信号发出后用于统计 *17kHz* 计数脉冲数，则所测距离 L 公式可用下式表示：
$$L = Q\/2×1\/17kHz×340m\/s = Q$$
采用17kHz作为计数脉冲，其周期个数在数值上等于超声波所测距离。通过这种简单的办法，就可以不用进行复杂的乘除法运算结果来占用过多的资源。在程序实现上，将 *17kHz* 波形作为时钟信号触发高速计数寄存器加一运算，寄存器的数据存储方式为：4 位二进制表示 1 位十进制，逢 “9” 进位到上 4 位。
## 显示模块
在数字电路中，数字与字符通常会使用代码或编码的形式来表现，这时就需要使用显示译码器对这些代码进行转译，并通过数码显示屏或数码显示管表达出来，将这些数字或字符直观地显示出来。不同的显示器件，驱动方式各不相同，显示方式也有所差异。比较常用的是类别是七段显示器，七段显示器件包括：发光二极管（LED）、液晶显示器（LCD）、荧光显示器和等离子显示器等。由于LED的驱动电压不高（1.5V~3V），并且工作电流只有十几毫安，这可以直接使用逻辑门电路来驱动，因此在多种嵌入式平台得到了广泛的应用。本项目采用7段LED数码显示管进行显示。
## 调试结果
可定制集成逻辑分析器（**ILA**）IP 核是一款逻辑分析器内核，由 *Xilinx* 公司开发，可用于监控设计中的内部信号。**ILA** IP 核上具备 AXI 接口，可用于调试系统中的使用 *AXI* 总线协议的 IP 核。在 *RTL* 代码设计中引入 **ILA** IP 核需要在顶层文件进行例化。**ILA** IP 核的工作形式是将探针（*Probe*）与待测信号相连接，在同一时钟信号的环境下检测出信号波形。同时待测信号的位宽须在 **ILA** IP 属性面板进行设置。<br><br>
<img src="https://github.com/MongooseOrion/UltraSonic-Design_based-on-FPGA/blob/main/v1.1/Picture/image.png" width = '700' alt="图片alt" title="测量结果示意" />
## 总结
本系统测试是在理想的实验室环境下进行的，请注意，测量精度可能由于室内测量环境的不同而有所差异。测量精度随距离的增大有减小的趋势，但总体控制在 ***5%*** 以内，尤其在 1 米内的精度很高。然而，超出5米后测量精度急剧下降，造成这种情况的原因可能是：随着距离增大，同尺寸的障碍物可反射超声波的面积相对而言变小了，超声波的频率不足使得回波信号比较微弱并且混有噪声，这就对传感器阈值判断产生了很大影响，从而影响了距离数值。综上，本系统的测距范围在 5 米内，在 1 米内最高可达 ***100%*** 测距精度。
